// ==UserScript==
// @name        Dark Hole - Twitter Posts
// @description Automated content deletion
// @namespace   https://github.com/geotrev/dark-hole
// @author      George Treviranus
// @run-at      document-idle
// @match       https://twitter.com/*/*
// @version     0.0.0
// @downloadURL https://github.com/geotrev/dark-hole/raw/main/dist/twitter-posts.user.js
// @updateURL   https://github.com/geotrev/dark-hole/raw/main/dist/twitter-posts.user.js
// @grant       none
// ==/UserScript==
!function(){"use strict";function e(){return document.querySelector('[data-testid="UserName"]')?.innerText.split("\n")?.[1]?.slice(1)||null}const t=new class{static queue=0;static DEFAULT_DELAY=2e3;constructor(){const e=document.createElement("div"),t=document.createElement("div");e.innerHTML='<div style="font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;position: fixed;top: 0px;right: 0px;bottom: unset;left: 0px;z-index: 4000;padding: 32px;pointer-events: none;display: flex;flex-direction: column;align-items: flex-end;" data-dh-notify-container></div>',t.innerHTML='<section role="region" style="pointer-events: auto;flex-wrap: wrap;background-color: #333;margin: 0px;color: #dedede;padding: 20px;border-radius: 8px;max-width: 280px;box-shadow: 0 5px 10px rgba(0,0,0,0.5);margin-bottom: 12px;" data-dh-notify><h3 style="margin-bottom: 8px;margin-top:0;padding: 0;font-weight: bold;font-size: 12px;" data-dh-notify-heading></h3><p style="font-size: 16px;line-height: 22px;padding: 0;margin:0 0 12px 0;" data-dh-notify-message></p></section>',this.notifyWrapper=e.firstElementChild,this.notifyEl=t.firstElementChild,document.body.appendChild(this.notifyWrapper),document.addEventListener("keydown",this.handleKeyDown,!0)}handleKeyDown=e=>{this.queueIsEmpty()||"Escape"!==e.key||(e.preventDefault(),this.dismiss())};queueIsEmpty=()=>this.queue<=0;dismiss=()=>{this.queueIsEmpty()||(this.notifyWrapper.removeChild(this.notifyWrapper.firstElementChild),this.queue-=1)};dismissAll=()=>{for(;!this.queueIsEmpty();)this.dismiss()};render=({title:e="",message:t,delay:n=this.DEFAULT_DELAY,actions:i=[]})=>{const a=this.notifyEl.cloneNode(!0);if(a.querySelector("[data-dh-notify-heading]").innerText=e?`[Dark Hole] ${e}`:"[Dark Hole]",t){a.querySelector("[data-dh-notify-message").innerText=t}if(i.length>0)for(const e of i){const t=document.createElement("button");t.dataset.dhNotifyAction=!0,t.style.marginInlineEnd="8px",t.innerText=e.label,t.addEventListener("click",(()=>{e.handler(),this.dismiss()})),a.appendChild(t)}this.notifyWrapper.appendChild(a),this.queue+=1,setTimeout(this.dismiss,n)}};function n(e){const n=`ðŸ›‘ Stopped script: Dark Hole - ${e}`;console.log({content:n}),t({content:n})}const i=new Map;let a=!1;async function o({handler:e,message:n,actionLabel:i}){t.render({message:n,actions:[{label:i,handler:e}],delay:6e4})}async function s({pathname:e,urlPaths:n,handler:r,message:l,actionLabel:d="ðŸ§¹ Begin Removal"}){if(i.has(e))return o({...i.get(e)});a=!0,n.some((t=>e===t))&&(i.set(e,{pathname:e,urlPaths:n,handler:r,message:l,actionLabel:d}),o({urlPaths:n,handler:r,message:l,actionLabel:d}),async function(){if(a)return;const e=history.pushState;history.pushState=function(){e.apply(history,arguments)},window?.addEventListener("popstate",(()=>{t.dismissAll();const e=window?.location?.pathname;i.has(e)&&s({...i.get(e)})}))}())}let r=!1;const l=e=>{"Escape"===e.key&&(r=!0)};async function d(t=[]){document.addEventListener("keydown",l,!0);let i=e();async function a(e=500){return new Promise((t=>setTimeout((()=>requestAnimationFrame(t)),e)))}function o(){return[...document.querySelectorAll('[data-testid="tweet"]')]}let s=t.length?t:o();console.log("ðŸ§¹ Deleting tweets");for(const e of s){if(r)return n("Twitter Posts"),void document.removeEventListener("keydown",l,!0);let t=e.closest('[data-testid="cellInnerDiv"]'),o=!!e.querySelector('[data-testid="User-Name"]')?.innerText.includes(`@${i}`),s=!!e.querySelector('[data-testid="socialContext"]'),d=e.querySelector('[data-testid="caret"]');if(s){e.querySelector('[data-testid="unretweet"]').click(),await a(),document.querySelector('[data-testid="Dropdown"] > [data-testid="unretweetConfirm"]').click()}else{if(!o)continue;d.click(),await a(),document.querySelector('[data-testid="Dropdown"] > [role="menuitem"]').click(),await a(),document.querySelector('[data-testid="confirmationSheetDialog"] [data-testid="confirmationSheetConfirm"]').click(),await a();let e=[...t.parentNode.children],n=e.indexOf(t);e.slice(0,n).forEach((e=>e.parentNode.removeChild(e)))}await a()}s=o(),s.length?(console.log("ðŸ§² There are more tweets to delete"),await d(s)):console.log("âœ¨ Done!")}!async function(){const n=await async function(e,n,i={}){const a=i.tries||10,o=i.interval||100,s=n||"Unable to resolve value after "+String(a*o)+"ms.";return new Promise(((i,r)=>{let l=0;const d=setInterval((()=>{const o=e();o&&(clearInterval(d),i(o)),++l===a&&(clearInterval(d),n&&t({content:s}),r())}),o)}))}(e);n&&s({title:"Twitter Posts",message:"Ready to clean up your data?\nNOTE: this is a destructive action. Make sure you have a backup of your data before proceeding.",handler:d,urlPaths:[`/${n}/with_replies`,`/${n}/media`]})}()}();
