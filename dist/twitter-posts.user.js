// ==UserScript==
// @name        Dark Hole - Twitter Posts
// @description Automated content deletion
// @namespace   https://github.com/geotrev/dark-hole
// @author      George Treviranus
// @run-at      document-idle
// @match       https://twitter.com/*
// @version     0.0.0
// @downloadURL https://github.com/geotrev/dark-hole/raw/main/dist/twitter-posts.user.js
// @updateURL   https://github.com/geotrev/dark-hole/raw/main/dist/twitter-posts.user.js
// @grant       none
// ==/UserScript==
!function(){"use strict";function e(){return document.querySelector('[data-testid="UserName"]')?.innerText.split("\n")?.[1]?.slice(1)||null}const t=new class{static queue=0;static DEFAULT_DELAY=2e3;constructor(){this.notifyWrapper=this.buildNotifyContainer(),this.notifyEl=this.buildNotification(),document.body.appendChild(this.notifyWrapper),document.addEventListener("keydown",this.handleKeyDown,!0)}handleKeyDown=e=>{this.queueIsEmpty()||"Escape"!==e.key||(e.preventDefault(),this.dismiss())};queueIsEmpty=()=>this.queue<=0;buildNotifyContainer=()=>{const e=document.createElement("div");return e.style.fontFamily="-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif",e.style.position="fixed",e.style.top="0px",e.style.right="0px",e.style.bottom="unset",e.style.left="0px",e.style.zIndex="4000",e.style.padding="32px",e.style.pointerEvents="none",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-end",e.dataset.dhNotifyContainer=!0,e};buildNotification=()=>{const e=document.createElement("section");e.style.pointerEvents="auto",e.style.flexWrap="wrap",e.style.backgroundColor="#333",e.style.margin="0px",e.style.color="#dedede",e.style.padding="20px",e.style.borderRadius="8px",e.style.maxWidth="280px",e.style.boxShadow="0 5px 10px rgba(0,0,0,0.5)",e.style.marginBottom="12px";const t=document.createElement("h3");t.style.marginBottom="8px",t.style.marginTop="0",t.style.padding="0",t.style.fontWeight="bold",t.style.fontSize="12px";const n=document.createElement("p");return n.style.fontSize="16px",n.style.lineHeight="22px",n.style.padding="0",n.style.margin="0 0 12px 0",e.dataset.dhNotify=!0,t.dataset.dhNotifyHeading=!0,n.dataset.dhNotifyMessage=!0,e.appendChild(t),e.appendChild(n),e};dismiss=()=>{this.queueIsEmpty()||(this.notifyWrapper.removeChild(this.notifyWrapper.firstElementChild),this.queue-=1)};dismissAll=()=>{for(;!this.queueIsEmpty();)this.dismiss()};render=({title:e="",message:t,delay:n=this.DEFAULT_DELAY,actions:i=[]})=>{const o=this.notifyEl.cloneNode(!0);if(o.querySelector("[data-dh-notify-heading]").innerText=`[Dark Hole] ${e}`,t){o.querySelector("[data-dh-notify-message").innerText=t}if(i.length>0)for(const e of i){const t=document.createElement("button");t.dataset.dhNotifyAction=!0,t.style.marginInlineEnd="8px",t.innerText=e.label,t.addEventListener("click",(()=>{e.handler(),this.dismiss()})),o.appendChild(t)}this.notifyWrapper.appendChild(o),this.queue+=1,setTimeout(this.dismiss,n)}};function n(e){const n=`ðŸ›‘ Stopped script: Dark Hole - ${e}`;console.log({content:n}),t({content:n})}const i=new Map;let o=!1,s=window?.location?.href;function a({handler:e,title:n,message:i,actionLabel:o}){t.render({title:n,message:i,actions:[{label:o,handler:e}],delay:6e4})}function l(){if(o)return;const e=history.pushState;history.pushState=function(){e.apply(history,arguments)},document?.addEventListener("click",(async()=>{const e=window?.location?.href;if(await async function(e=50){return new Promise((()=>setTimeout((()=>requestAnimationFrame((()=>{}))),e)))}(),s!==e){s=e,t.dismissAll();const n=window?.location?.pathname;i.has(n)&&r({...i.get(n)})}}),!0)}async function r({pathname:e,title:t,urlPaths:n,handler:s,message:r="Ready to clean up your data?\nNOTE: this is a destructive action. Make sure you have a backup of your data before proceeding.",actionLabel:d="ðŸ§¹ Begin Removal"}){if(i.has(e))return a({...i.get(e)});o=!0,n.some((t=>e===t))&&(i.set(e,{pathname:e,urlPaths:n,handler:s,title:t,message:r,actionLabel:d}),a({urlPaths:n,title:t,handler:s,message:r,actionLabel:d}),l())}let d=!1;const c=e=>{"Escape"===e.key&&(d=!0)};async function u(t=[]){document.addEventListener("keydown",c,!0);let i=e();async function o(e=500){return new Promise((t=>setTimeout((()=>requestAnimationFrame(t)),e)))}function s(){return[...document.querySelectorAll('[data-testid="tweet"]')]}let a=t.length?t:s();console.log("ðŸ§¹ Deleting tweets");for(const e of a){if(d)return n("Twitter Posts"),void document.removeEventListener("keydown",c,!0);let t=e.closest('[data-testid="cellInnerDiv"]'),s=!!e.querySelector('[data-testid="User-Name"]')?.innerText.includes(`@${i}`),a=!!e.querySelector('[data-testid="socialContext"]'),l=e.querySelector('[data-testid="caret"]');if(a){e.querySelector('[data-testid="unretweet"]').click(),await o(),document.querySelector('[data-testid="Dropdown"] > [data-testid="unretweetConfirm"]').click()}else{if(!s)continue;l.click(),await o(),document.querySelector('[data-testid="Dropdown"] > [role="menuitem"]').click(),await o(),document.querySelector('[data-testid="confirmationSheetDialog"] [data-testid="confirmationSheetConfirm"]').click(),await o();let e=[...t.parentNode.children],n=e.indexOf(t);e.slice(0,n).forEach((e=>e.parentNode.removeChild(e)))}await o()}a=s(),a.length?(console.log("ðŸ§² There are more tweets to delete"),await u(a)):console.log("âœ¨ Done!")}!async function(){const n=await async function(e,n,i={}){const o=i.tries||10,s=i.interval||100,a=n||"Unable to resolve value after "+String(o*s)+"ms.";return new Promise(((i,l)=>{let r=0;const d=setInterval((()=>{const s=e();s&&(clearInterval(d),i(s)),++r===o&&(clearInterval(d),n&&t({content:a}),l())}),s)}))}(e);n&&r({pathname:window?.location?.pathname,title:"Twitter Posts",handler:u,urlPaths:[`/${n}`,`/${n}/with_replies`,`/${n}/media`]})}()}();
